<template>
  <section class="about_wrap">
    <p ref="scrollText" class="scroll_text">Scroll</p>
    <!-- Intro / How I Work / Why This portfolio -->
    <article
      v-for="(article, i) in sections"
      :key="i"
      class="about_article container"
      :class="article.area"
    >
      <h2>{{ article.title }}</h2>
      <p v-html="article.text"></p>
    </article>
    <!-- Portfolio Structure -->
    <article ref="sectionRef" class="portfolio_structure container">
      <div class="inner">
        <h2 class="structure_title">Portfolio Structure</h2>
        <div class="stack_diagram">
          <!-- Stack Cards -->
          <div class="stack">
            <div v-for="(item, index) in stackItems" :key="index" class="stack_card">
              <strong class="label">
                {{ item.label }}
                <span v-if="item.api" class="api_badge">API</span>
              </strong>

              <p class="desc">{{ item.desc }}</p>
              <p class="desc">{{ item.subDesc }}</p>
              <span class="number">0{{ 1 + index }}</span>
              <a v-if="item.code" :href="item.code" target="_blank" class="code_link">
                View Code â†’ </a
              ><br />
              <a v-if="item.codeAPI" :href="item.codeAPI" target="_blank" class="code_link">
                View Code APIâ†’
              </a>
            </div>
          </div>
        </div>
      </div>
    </article>
  </section>
  <section ref="endingText" class="mop_wrap container">
    <p class="ending_text">
      ì´ í¬íŠ¸í´ë¦¬ì˜¤ëŠ” 4ë…„ê°„ì˜ ì‹¤ë¬´ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ
      <strong>í™•ì¥ ê°€ëŠ¥í•œ ë°ì´í„° êµ¬ì¡°ì™€ ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ ì„¤ê³„</strong>ë¥¼ ì ìš©í•œ ì‘ì—…ë¬¼ì…ë‹ˆë‹¤.<br /><br />

      Nuxt.jsë¥¼ í™œìš©í•œ ë¸Œëœë“œ ì‚¬ì´íŠ¸ ì œì‘ ê²½í—˜ì„ í†µí•´ ë°ì´í„° íë¦„ê³¼ êµ¬ì¡° ì„¤ê³„ì˜ ì¤‘ìš”ì„±ì„ ë°°ì› ìœ¼ë©°,
      ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥í•œ í¬íŠ¸í´ë¦¬ì˜¤ ì‹œìŠ¤í…œì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.<br /><br />

      ì›¹ í‘œì¤€, ì ‘ê·¼ì„±, ì„±ëŠ¥ ìµœì í™”ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ë¬´ì—ì„œ ìš”êµ¬ë˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ì—­ëŸ‰ì„ ê°–ì¶”ê³ 
      ìˆìŠµë‹ˆë‹¤.
    </p>
  </section>
</template>

<script setup>
import AppFooter from '~/components/AppFooter.vue';

const sections = [
  {
    area: 'intro',
    title: 'Intro',
    text: `
      4ë…„ê°„ ì›¹ í¼ë¸”ë¦¬ì‹±ê³¼ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ê²½í—˜ì„ ìŒ“ì•˜ìŠµë‹ˆë‹¤.
      Nuxt.jsë¥¼ í™œìš©í•œ ë¸Œëœë“œ ì‚¬ì´íŠ¸ì™€ ì›¹ í”Œë«í¼ì„ ì œì‘í•˜ë©°
      ë‹¨ìˆœíˆ í™”ë©´ì„ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ë„˜ì–´, ë°ì´í„° êµ¬ì¡°ì™€ í™•ì¥ ê°€ëŠ¥í•œ ì„¤ê³„ë¥¼ ê³ ë¯¼í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
    `,
  },
  {
    area: 'how',
    title: 'How I Work',
    text: `
      ì›¹ í‘œì¤€ê³¼ ì ‘ê·¼ì„±ì„ ì¤€ìˆ˜í•œ ì‹œë§¨í‹± ë§ˆí¬ì—…ì„ ê¸°ë°˜ìœ¼ë¡œ,
      ë°˜ì‘í˜•/ë¶„ë¦¬í˜• ì›¹ì‚¬ì´íŠ¸ì™€ í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì§•ì„ ëŒ€ì‘í•©ë‹ˆë‹¤.
      ì»´í¬ë„ŒíŠ¸ ë‹¨ìœ„ë¡œ êµ¬ì¡°ë¥¼ ë¶„ë¦¬í•˜ê³  ë°ì´í„° íë¦„ì„ ë¨¼ì € ì„¤ê³„í•˜ì—¬
      ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥í•œ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
    `,
  },
  {
    area: 'purpose',
    title: 'Technical Approach',
    text: `
      ì´ í¬íŠ¸í´ë¦¬ì˜¤ëŠ” ë°ì´í„° ì¤‘ì‹¬ ì„¤ê³„ë¥¼ í†µí•´ í”„ë¡œì íŠ¸ ì¶”ê°€ ì‹œ
      ì½”ë“œ ë³€ê²½ ì—†ì´ JSON ë°ì´í„°ë§Œìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥í•˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
      ì‹¤ë¬´ì—ì„œ í•™ìŠµí•œ Nuxt.js, GSAP, SCSSë¥¼ í™œìš©í•˜ì—¬
      ì‹¤ì œ ì„œë¹„ìŠ¤ì²˜ëŸ¼ ë™ì‘í•˜ëŠ” êµ¬ì¡°ë¥¼ ëª©í‘œë¡œ ì œì‘í–ˆìŠµë‹ˆë‹¤.
    `,
  },
];

const stackItems = [
  {
    label: 'Data Modeling',
    desc: 'Excel ê¸°ë°˜ì˜ ì •ê·œí™”ëœ ë°ì´í„° ìŠ¤í‚¤ë§ˆë¥¼ ì„¤ê³„í•˜ì—¬ í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ êµ¬ì¡°í™”í–ˆìŠµë‹ˆë‹¤.',
    code: '/data/raw/projects.xlsx',
  },
  {
    label: 'Data Layer',
    desc: 'í™”ë©´ê³¼ ë…ë¦½ëœ JSON ê¸°ë°˜ ë°ì´í„° ë ˆì´ì–´ë¥¼ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.',
    code: '/data/raw/projects.json',
    codeAPI: `/api/projects`,
  },
  {
    label: 'API Architecture',
    desc: 'Nuxt 4 Server Routesë¥¼ í™œìš©í•œ RESTful API ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.',
    subDesc: `ì •ì  ë°ì´í„°ì™€ API ê¸°ë°˜ êµ¬ì¡°ë¥¼ í™˜ê²½ë³€ìˆ˜(Runtime Config)ë¡œ ì „í™˜ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
		í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ìˆ˜ì • ì—†ì´ ë°ì´í„° ì†ŒìŠ¤ë¥¼ êµì²´í•  ìˆ˜ ìˆì–´,
		ì‹¤ë¬´ í™˜ê²½ì—ì„œë„ ìµœì†Œí•œì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¹„ìš©ìœ¼ë¡œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    code: '/code/projects.js',
    api: true,
  },
  {
    label: 'Dynamic Routing',
    desc: 'File-based Routingê³¼ ë™ì  íŒŒë¼ë¯¸í„°ë¥¼ í™œìš©í•˜ì—¬ í”„ë¡œì íŠ¸ë³„ ìƒì„¸ í˜ì´ì§€ë¥¼ ìë™ ìƒì„±í–ˆìŠµë‹ˆë‹¤.',
  },
  {
    label: 'Runtime Config',
    desc: `Nuxt 4ì˜ runtimeConfigë¥¼ í™œìš©í•œ í™˜ê²½ë³„ ì„¤ì • ê´€ë¦¬ ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

		â€¢ dataSource: 'static' - ì •ì  JSON íŒŒì¼ (SSG ìµœì í™”)
		â€¢ dataSource: 'api' - API ì—”ë“œí¬ì¸íŠ¸ (SSR ì‹¤ë¬´ í™˜ê²½)

		í™˜ê²½ë³€ìˆ˜ ì „í™˜ë§Œìœ¼ë¡œ ê°œë°œ/í”„ë¡œë•ì…˜ í™˜ê²½ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
  },
];
const sectionRef = ref(null);
const scrollText = ref(null);
const endingText = ref(null);

let ctx = null;
let mm = null;
let mobileObserver = null;

const initMobileObserver = () => {
  const { $gsap } = useNuxtApp();

  const section = sectionRef.value;
  if (!section) return;

  const cards = section.querySelectorAll('.stack_card');
  if (!cards.length) return;

  // ì´ˆê¸° ìƒíƒœ
  $gsap.set(cards, {
    opacity: 0,
    y: 40,
    scale: 1,
  });

  mobileObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (!entry.isIntersecting) return;

        $gsap.to(entry.target, {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power2.out',
        });

        mobileObserver.unobserve(entry.target);
      });
    },
    {
      threshold: 0.25,
      rootMargin: '0px 0px -10% 0px',
    }
  );

  cards.forEach((card) => mobileObserver.observe(card));
};

const initDesktopScroll = () => {
  const { $gsap, $ScrollTrigger } = useNuxtApp();

  const section = sectionRef.value;
  if (!section) return;

  const cards = section.querySelectorAll('.stack_card');
  if (!cards.length) return;

  ctx = $gsap.context(() => {
    const cardHeight = cards[0].offsetHeight;
    const STACK_GAP = 40;
    const totalSteps = cards.length + 1;
    const CARD_SCROLL = (cardHeight + STACK_GAP) * totalSteps;

    // ì´ˆê¸° ìƒíƒœ
    $gsap.set(cards, {
      opacity: 0,
      y: (i) => i * STACK_GAP * 2,
      scale: 0.96,
    });

    const tl = $gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: 'top top',
        end: `+=${CARD_SCROLL}`,
        scrub: true,
        pin: true,
        invalidateOnRefresh: true,
        markers: false,

        onUpdate(self) {
          // ìŠ¤í¬ë¡¤ ì•ˆë‚´ í…ìŠ¤íŠ¸
          $gsap.set(scrollText.value, {
            autoAlpha: self.progress > 0.95 ? 0 : 1,
          });

          // ì—”ë”© í…ìŠ¤íŠ¸
          $gsap.set(endingText.value, {
            autoAlpha: self.progress > 0.1 ? 1 : 0,
          });
        },
      },
    });

    cards.forEach((card, index) => {
      tl.to(card, {
        opacity: 1,
        y: index * STACK_GAP,
        scale: 1,
        ease: 'power2.out',
      });

      if (index > 0) {
        tl.to(
          cards[index - 1],
          {
            scale: 0.9,
            ease: 'power2.out',
          },
          '<'
        );
      }
    });

    // ë§ˆì§€ë§‰ ì¹´ë“œ ì •ë¦¬
    tl.to(cards[cards.length - 1], {
      scale: 0.9,
      ease: 'power2.out',
    });
  }, section);

  $ScrollTrigger.refresh();
};
const initScrollAnimation = () => {
  if (!process.client) return;

  const { $ScrollTrigger } = useNuxtApp();

  $ScrollTrigger.matchMedia({
    // ğŸ–¥ Desktop
    '(min-width: 769px)': () => {
      initDesktopScroll();

      return () => {
        if (ctx) {
          ctx.revert();
          ctx = null;
        }
      };
    },

    // Mobile
    '(max-width: 768px)': () => {
      initMobileObserver();

      return () => {
        if (mobileObserver) {
          mobileObserver.disconnect();
          mobileObserver = null;
        }
      };
    },
  });
};

onMounted(() => {
  nextTick(() => {
    initScrollAnimation();
  });
});

onUnmounted(() => {
  if (ctx) ctx.revert();
  if (mobileObserver) mobileObserver.disconnect();
});
</script>
<style lang="scss" scoped>
@use '@/assets/scss/abstracts/_mediaQuery.scss' as *;
.about_wrap {
  justify-content: flex-start;
  .scroll_text {
    display: none;
    position: fixed;
    left: 50%;
    bottom: 0%;
    transform: translateX(-50%);
    font-size: 20vw;
    mix-blend-mode: difference;
    z-index: 1;
    animation: sparkle 3s ease-in Infinite Alternate;
  }
  @keyframes sparkle {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  .about_article {
    height: fit-content;
    margin-bottom: 4rem;
    white-space: pre-line;
    p {
      line-height: 1.8;
    }
    h2 {
      font-size: clamp(1.4rem, 2vw, 1.6rem);
    }
    p,
    strong {
      font-size: clamp(1rem, 2vw, 1.4rem);
    }
  }
  $articles: (
    intro: intro,
    how: how,
    purpose: purpose,
  );
  @include media-breakpoint-up {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-areas: 'intro how purpose' 'structure structure structure' 'mop mop mop';
    gap: 4rem;
    .scroll_text {
      display: block;
    }
    .about_article {
      margin-bottom: 8rem;
      p {
        padding-left: 2rem;
        font-size: 1.4rem;
      }
    }
    @each $name, $area in $articles {
      .#{$name} {
        grid-area: $area;
      }
    }
  }
}

.portfolio_structure {
  position: relative;
  grid-area: structure;
  padding-top: 2rem;
  padding-bottom: 2rem;
  background: var(--background-inversion-color);
  .structure_title {
    color: var(--background-color);
  }
  .stack_diagram {
    position: relative;
    margin-top: 2rem;
    min-height: 40rem;
  }
  @include media-breakpoint-up {
    padding-top: 4rem;
    padding-bottom: 4rem;
    .stack_diagram {
      margin-top: 4rem;
    }
  }
}

.stack {
  position: relative;
  z-index: 1;
  .stack_card {
    width: 100%;
    min-height: 20rem;
    padding: 2rem;
    border-radius: 1.2rem;
    background: var(--color-bg, #fff);
    box-shadow: 0 1.2rem 4rem rgba(0, 0, 0, 0.12);
    font-size: 1.2rem;
    color: #303030;
    & + .stack_card {
      margin-top: 2rem;
    }
  }
  .label {
    display: flex;
    align-items: center;
    font-weight: 600;
  }

  .desc {
    margin-top: 0.75rem;
    margin-bottom: 2rem;
    line-height: 1.6;
    white-space: pre-line;
  }
  .number {
    position: absolute;
    bottom: 2rem;
    right: 2rem;
    font-size: 4rem;
    opacity: 0.4;
  }
  .code_link {
    display: inline-block;
    margin-top: 1rem;
    color: #4f7cff;
    font-size: 1rem;
    text-decoration: underline;
  }
  @include media-breakpoint-up {
    .stack_card {
      position: absolute;
      top: 0;
      left: 0;
      & + .stack_card {
        margin-top: 0;
      }
    }
    .code_link {
      font-size: 1.2rem;
    }
  }
}

.api_badge {
  margin-left: 0.5rem;
  padding: 0.2rem 0.5rem;
  font-size: 0.7em;
  border-radius: 4px;
  background: #111;
  color: #fff;
}

.mop_wrap {
  padding-top: 4rem;
  padding-bottom: 4rem;
  grid-area: mop;
  transition: none;
  font-size: clamp(1rem, 2vw, 1.4rem);
  text-align: center;
  line-height: 1.6;
}
</style>
